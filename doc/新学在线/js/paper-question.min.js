function _getElementTop(e){for(var t=e.offsetTop,i=e.offsetParent;null!=i;)t+=i.offsetTop+i.clientTop,i=i.offsetParent;return t}OT2.Paper.Question=function(){var e=function(e,t,i,s){this.$el=null,this.paper=e,this.section=t||null,this.model=i,this.attributes={id:0,type:null,score:0,subScore:[],order:0},this.attributes=$.extend(!0,{},this.attributes,i.score),this.attributes=$.extend(!0,{},this.attributes,s),this.paper.cacheObj[this.model.id]=this.attributes,this.enableSortable=!1,this.template=OT2.Util.Template().get("paper-question"),this.init()};return e.zIndex=100,e.prototype={init:function(){this.render(),this.bindEvents(),this.listen(),this.sortable()},initScore:function(){var e=0;if(Number(this.model.question_type)<6)switch(this.model.question_type){case"1":e=2;break;case"2":e=3;break;case"3":e=2;break;case"4":e=2;break;case"5":e=5}else"7"==this.model.question_type?_.each(this.model.list,function(t,i){if(Number(t.question_type)<6)switch(t.question_type){case"1":e+=2;break;case"2":e+=3;break;case"3":e+=2;break;case"4":e+=2;break;case"5":e+=5}else"6"==t.question_type&&(e+=1*t.options.length)}):6==Number(this.model.question_type)&&(e=1*this.model.options.length);return e},render:function(e){if(e)this.$el=e;else{this.$el=$(_.template(this.template,{self:this}));var t={className:".op-items"};this.model.index=this.attributes.order,this.model.q=this;var i=new OT2.QuestionTxt(this.model,this.paper,t);i.render(),this.$el.prepend(i.$el)}return this},serialize:function(){this.paper.cacheObj[this.model.id]=this.attributes,this.paper.serialize()},listen:function(){var e=this;this.paper.subscribe("question:sum",function(t,i){e.section===t&&i.push(e)}),this.paper.subscribe("question:list",function(t,i){e.paper==t&&i.push(e)}),this.paper.subscribe("question:changeType",function(t,i){e.attributes.type==i&&(e.attributes.type=t,e.paper.cacheObj[e.attributes.id].type=t,e.paper.serialize())}),this.paper.subscribe("question:deleteBatch",function(t){return e.attributes.type==t&&void("undefined"!=typeof e.paper&&null!=e.paper&&e.paper.publish("question:destroyBatch",e))}),this.paper.subscribe("question:setorder",function(t,i){if(e.$el.attr("id")==t){e.attributes.order=i;var s=e.paper.cacheObj[e.attributes.id];s&&(s.order=i)}}),this.paper.subscribe("question:sort",function(t,i){return t==e.attributes.type&&void(e.enableSortable="enable"==i)}),this.section.subscribe("section:multi:setscore",function(t,i){var s=e.model.question_channel_type,n=e.model.question_type;if(6==n||7==n)return!1;if([n,s].join(",")!=i)return!1;var r=t;4==n&&(r=t*_.size(e.model.myanswer)),e.attributes.score=r,e.attributes.subScore=[t],e.serialize(),e.$el.find(".q-scoreval").html("（"+r+"分）"),e.section.publish("section:score"),e.paper.renderSideTypes()}),this.paper.subscribe("question:scrolltoview",function(t){e.model.question_id==t&&e.scrollToView()})},scrollToView:function(){var e=this,t=$(document.body||document.documentElement).scrollTop(),i=$(window).height(),s=0,n=e.$el.get(0),s=_getElementTop(n);(s<t+i/3||s>t+i/3)&&(s-=i/3,$("html,body").animate({scrollTop:s},"slow")),e.$el.css("background-color","#cee5db"),setTimeout(function(){e.$el.css("background-color","#ffffff")},1500)},bindEvents:function(){var e=this;this.$el.find(".del-btn").on("click",function(){e.$el.fadeOut(function(){$(this).remove(),e.paper.publish("question:destroy",e)})}),this.$el.find(".zy-btn").on("click",function(){e.transfer().done(function(t){t&&t!=e.attributes.type&&e.paper.publish("question:transfer",e,e.attributes.type,t)})}),this.$el.find(".ht-btn").on("click",function(){var t=e.paper,i={id:e.attributes.id,ids:t.basketQids};$.post("/question/relation",i,"json").done(function(s){if(0!==s.errCode)return!1;if(i=s.data,!i)return OT2.Util.alert("抱歉，没有类似试题可换！"),!1;i.id=i.question_id;var n={id:i.question_id,type:e.attributes.type,order:e.attributes.order,order2:e.attributes.order2,score:e.attributes.score,xd:i.xd,xk:i.chid},r=new OT2.Paper.Question(t,e.section,i,n);e.$el.after(r.$el),e.$el.remove(),r.$el.find(".q-sn").text(e.attributes.order2),t.publish("question:replace",e,r),t.renderSideTypes()})}),this.$el.find(".score-btn").on("click",function(){var t=OT2.Util.Template().get("dialog-score"),i=PARAMS.question_types||{},s=$(_.template(t,{self:e,qctypes:i}));$form=s.find("#dialog-score-form"),s.find("input").on("blur",function(){var e=parseFloat(this.value);this.value=isNaN(e)?0:e,n()});var n=function(){var e=0,t=[];return $form.find("input[name=score]").each(function(){var i=$(this).data("n")||null,s=Number(this.value)||0;e+=i?s*i:s,t.push(s)}),s.find(".s-total").html(e),{detail:t,score:e}};n();var r=dialog({title:"分数设置："+e.attributes.type+" - 第（"+e.attributes.order2+"）题",content:s.get(0),fixed:!0,okValue:"确定",cancelValue:"取消",ok:function(){var t=n();e.attributes.score=t.score,e.attributes.subScore=t.detail[0]&&t.detail,e.serialize(),e.$el.find(".q-scoreval").html("（"+t.score+"分）"),e.section.publish("section:score"),e.paper.renderSideTypes()},cancel:function(){}});r.showModal()})},transfer:function(){var e=$.Deferred(),t=$(_.template(OT2.Util.Template().get("dialog-transfer"),{self:this})),i=[],s="";t.find(".radiobox").each(function(){new OT2.Element.radio(this,i).bindEvent(function(){s=this.$input.val()})});var n=dialog({title:"试题转移",width:500,content:t.get(0),fixed:!0,okValue:"确定",cancelValue:"取消",ok:function(){e.resolve(s),n.close()},cancel:function(){}});return n.showModal(),e.promise()},sortable:function(){var t=this,i=$(document),s=!1,n=null,r=null,o=0,a=0,l=!1,u=0;this.$el.mousedown(function(i){if(s=!0,r=t.$el.siblings(),0==r.length&&(s=!1),$(i.target).parents(".question-btngroup").length>0&&(s=!1),!s)return!1;var l=t.$el.width(),c=t.$el.height();n=t.$el.clone(),n.attr("id","clone-div"),n.css({position:"absolute",width:l,height:c,"z-index":e.zIndex++}),t.section.$el.css("z-index",e.zIndex),x0=t.$el.offset().left,a=t.$el.offset().top,o=i.clientY-a,u=a,n.offset({left:x0,top:a}),$("#clone-div").length<1&&t.$el.parent().append(n),t.$el.addClass("dragging")}),i.mousemove(function(e){if(s){var i=e.clientY-o;n.offset({left:x0,top:i}),l=i>=u,u=i,r.each(function(){var e=$(this).offset().top,s=$(this).height();i>e&&i<e+s&&t.$el[l?"insertAfter":"insertBefore"](this)})}}),i.mouseup(function(){s&&(n.remove(),t.$el.removeClass("dragging"),t.enableSortable||t.section.publish("question:resort"),t.paper.renderSideTypes()),s=!1})},setScore:function(){}},e}();