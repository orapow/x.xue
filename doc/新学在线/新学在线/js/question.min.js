OT2.Basket=function(){function t(e){if(!(this instanceof t))return new t(e);OT2.Event.call(this),this.el=e||document.createElement("div"),this.$el=$(this.el),this.$list=this.$el.find(".basket-count"),this.isVisible=this.$el.hasClass("active"),this.activeClass="active",this.model=[],this.cacheObj=[],this.unserialize(),this.render(),this.bindEvent(),this.wireIframe=OT2.Wireiframe()}var e=_.template(OT2.Util.Template().get("basketList"));return t.prototype={changeVisual:function(){this.isVisible=!this.isVisible,this.$el[this.isVisible?"addClass":"removeClass"](this.activeClass)},bindEvent:function(){var t=this;this.$el.find(".basket-tit").on("click",function(){t.changeVisual()}),t.subscribe("Question:add",function(e){if(_.contains(t.model,e.id))return!1;t.model.push(e.id),t.cacheObj[e.id]={id:e.id,type:e.type,xd:e.xd,xk:e.xk},t.serialize()}),t.subscribe("Question:move",function(e){t.wireIframe.move(e,t)}),t.subscribe("Question:remove",function(e){t.model=_.without(t.model,e.id),t.cacheObj[e.id]&&delete t.cacheObj[e.id],t.serialize()})},getPosition:function(){var t=this.$el.offset(),e=this.$el.width();this.$el.height();return{left:t.left+e,top:t.top}},serialize:function(){OT2.LocalData.set("basket_cacheObj",JSON3.stringify(this.cacheObj)),this.render()},unserialize:function(){var t=this;this.cacheObj={};try{this.cacheObj=JSON3.parse(OT2.LocalData.get("basket_cacheObj"))||{}}catch(t){}this.model=[],_.each(this.cacheObj,function(e){t.model.push(e.id)})},render:function(){this.$list.empty();for(var t,i={},s=0,a=0;t=this.model[a++];){var n=this.cacheObj[t];if(n&&(void 0===OT2.xd_chid||n.xk==OT2.xd_chid.chid&&n.xd==OT2.xd_chid.xd)){var d=n.type;void 0===i[d]?i[d]=[t]:i[d].push(t),s++}}var o=_.map(i,function(t,e){return{key:e,val:t,id:1e3}});if("undefined"!=typeof PARAMS&&PARAMS.question_types){var l=_.invert(PARAMS.question_types);o=_.map(i,function(t,e){return{key:e,val:t,id:l[e]?Number(l[e]):1e3}}),o=o.sort(function(t,e){return t.id-e.id})}this.$list.append(e({num:s,list:o}))},getLenght:function(t){var e=0;for(var i in t)e++;return e},removeAll:function(t){var e=this,i=[].slice.call(arguments,1);dialog({title:"友情提示",content:'你确定要删除"'+t+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){_ids=_.map(i,function(t){return t+""}),e.model=_.difference(e.model,i),e.model=_.difference(e.model,_ids);for(var s,a=0;s=i[a++];)e.publish("remove:byid",s),delete e.cacheObj[s];e.deleteQtypeWithXdXk(t),e.serialize()},cancel:function(){this.close()}}).showModal()},deleteQtypeWithXdXk:function(t){var e="";if(void 0!==OT2.xd_chid){var i=OT2.xd_chid.xd,s=OT2.xd_chid.chid,e=["paper2016",i,s].join(":"),a=OT2.LocalData.get(e);if(!a||0==a.length)return!1;var n={};try{n=JSON3.parse(a)||{}}catch(t){}void 0!==n.types&&void 0!==n.types[t]&&(delete n.types[t],OT2.LocalData.set(e,JSON3.stringify(n)))}}},_.extend(t.prototype,OT2.Event.prototype),t}(),OT2.Wireiframe=function(){var t=null;return function(){return t||(t={$el:$("<div>"),init:function(){this.$el.css({position:"absolute",display:"none"}),this.$el.appendTo(document.body)},move:function(t,e){var i=t.$el,s=i.position(),a=i.width(),n=i.height();this.$el.css({width:a,height:n,left:s.left,top:s.top,opacity:1}),this.$el.show();var d=e.getPosition();d.width=0,d.height=0,this.$el.append(i.clone(!1));var o=Math.abs(d.left-s.left),l=Math.abs(d.top-s.top),h=Math.sqrt(o*o+l*l)/2.5;this.$el.animate(d,h,function(){$(this).empty(),$(this).hide()})}}),t.init(),t}}(),OT2.Question=function(){var t=_.template(OT2.Util.Template().get("question-item")),e=_.template(OT2.Util.Template().get("exam-point")),i=_.template(OT2.Util.Template().get("exam-answer")),s=_.template(OT2.Util.Template().get("exam-explanation")),a=function(t,e){this.basket=e,this.model={added:!1},void 0!==t.added&&(this.model.added=t.added),_.extend(this.model,t),this.$el=null,this.$addBtn=null,this.visibled_analyticbox=!1,this.rendered_analyticbox=!1};return a.prototype={render:function(e){var i=this;if(e)this.$el=e,this.basket.subscribe("question:width",function(){i.$el.find(".exam-s").each(function(){OT2.Util.calcItemWidth($(this))})});else{var s=$(t(this.model)),a=new OT2.QuestionTxt(this.model,this.basket);a.render(),s.find(".exam-head").after(a.$el),this.$el=s}return this.cacheElements(),this.bindEvent(),this},show_analyticbox:function(){var t="undefined"==typeof USER?{uid:null}:USER;if(!1===this.rendered_analyticbox){this.rendered_analyticbox=!0,this.$el.find(".exam-foot").before('<div class="analyticbox-brick"></div>');var a=e({q:this.model,user:t});this.$el.find(".analyticbox-brick").append(a),"7"==this.model.question_type?(a=_.map(this.model.list,function(e,s){return i({q:e,user:t})}),this.$el.find(".exam-qlist > .exam-con").each(function(t,e){$(this).after(a[t])})):(this.$el.find(".analyticbox-brick").addClass("analyticbox-brick-normal"),a=i({q:this.model,user:t}),this.$el.find(".analyticbox-brick").append(a)),a=s({q:this.model,user:t}),this.$el.find(".analyticbox-brick").append(a),this.$el.addClass(this.model.explanation?"beauty-man":"uglify-man")}this.$el[this.visibled_analyticbox?"addClass":"removeClass"]("visible-ake"),this.$el.find(".analyticbox, .analyticbox-brick")[this.visibled_analyticbox?"show":"hide"]()},cacheElements:function(){this.$addBtn=this.$el.find(".J_AddQuestion")},addToBasket:function(){this.model.added=!0,this.$addBtn.html("<b>-</b>移除"),this.$addBtn.addClass("removebtn"),this.$addBtn.removeClass("addbtn")},removeFromBasket:function(){this.model.added=!1,this.$addBtn.html("<b>+</b>选题"),this.$addBtn.removeClass("removebtn"),this.$addBtn.addClass("addbtn")},addOrRemove:function(t){if(!this.model.added||t&&void 0!==t){var e=this.countQnumsByChid();if(void 0===USER.basketLimit&&(USER.basketLimit=30),e>=USER.basketLimit){var i="抱歉，您的试题篮最多可选"+USER.basketLimit+"道试题";return USER.isVip||0!=USER.school_permit_id||(i+='</br><span style="color:#666666;font-size:12px">vip用户可选50道试题，<a href="/payment/vip" target="_blank" class="notice-pjq">开通vip</a><span>'),OT2.Util.alert(i,1),!1}this.addToBasket(),this.basket.publish("Question:add",this.model),this.basket.publish("Question:move",this)}else this.removeFromBasket(),this.basket.publish("Question:remove",this.model)},countQnumsByChid:function(){return void 0!==OT2.xd_chid?_.filter(this.basket.cacheObj,function(t){return t.xk==OT2.xd_chid.chid&&t.xd==OT2.xd_chid.xd}).length:this.basket.model.length},bindEvent:function(){var t=this;this.$addBtn.on("click",function(){t.addOrRemove()}),this.basket.subscribe("remove:byid",function(e){if(e!=t.model.id)return!1;t.basket.model=_.without(t.basket.model,e),t.basket.model=_.without(t.basket.model,""+e),t.removeFromBasket()}),this.$el.find(".search-exam").children(".exam-con").on("click",function(e){t.visibled_analyticbox=!t.visibled_analyticbox,t.show_analyticbox()}),this.basket.subscribe("show-analyticbox",function(e){t.visibled_analyticbox=e,t.show_analyticbox()})}},a}();