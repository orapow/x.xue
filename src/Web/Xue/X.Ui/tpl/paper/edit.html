<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>试卷编辑</title>
    <link rel="stylesheet" href="/plug/bs/v2.3.2.css" />
    <link rel="stylesheet" href="/css/xx/my.css" />
    <link rel="stylesheet" href="/css/xx/base.min.css" />
    <link rel="stylesheet" href="/css/xx/spriter-mix.min.css" />
    <link rel="stylesheet" href="/css/xx/main.min.css" />
    <link rel="stylesheet" href="/css/xx/manual.min.css" />
    <link rel="stylesheet" href="/css/xx/inner-user.min.css" />
    <link rel="stylesheet" href="/css/xx/paperediting.min.css" />
    <link rel="stylesheet" href="/css/x.dialog.css" />

    <script type="text/javascript">
        window.OT2 = {}; // 全局命名空间
    </script>

    <script type="text/javascript" src="/js/xx/jquery.min.js"></script>
    <script type="text/javascript" src="/js/xx/underscore-min.js"></script>
    <script type="text/javascript" src="/js/xx/util.min.js"></script>
    <style type="text/css">
        .breadcrumb { padding: initial; background-color: transparent; }
        .editset-type .btn { padding: 0; }
        .question-num p { display: inline; }
    </style>

</head>

<body>
    #parse("_top.html")
    <div class="breadcrumb g-container"> <i class="icona-dingwei"></i>当前位置： <a href="#">首页</a> <b>&gt;</b> <a href="#">$sbname</a> </div>
    <div class="g-bd1 g-container f-cb" id="J_PaperLayout">
        <div class="g-sd1">
            <div class="editset f-usn" onselectstart="return false">
                <h3>试卷结构调整</h3>
                <div id="sd-set-wire">
                    <div class="check-group">
                        <ul id="J_PaperSetCheck">
                            <li>
                                <span class="checkbox" data-sw="1">
                                    <i class="icona-check"></i>
                                    密封线
                                </span>
                            </li>
                            <li>
                                <span class="checkbox  checked" data-sw="3">
                                    <i class="icona-check"></i>
                                    主标题
                                </span>
                            </li>

                            <li>
                                <span class="checkbox" data-sw="5">
                                    <i class="icona-check"></i>
                                    副标题
                                </span>
                            </li>
                            <li>
                                <span class="checkbox" data-sw="4">
                                    <i class="icona-check"></i>
                                    注意事项
                                </span>
                            </li>

                            <li>
                                <span class="checkbox" data-sw="7">
                                    <i class="icona-check"></i>
                                    考试时间
                                </span>
                            </li>

                            <li>
                                <span class="checkbox" data-sw="9">
                                    <i class="icona-check"></i>
                                    考生填写
                                </span>
                            </li>
                            <li>
                                <span class="checkbox" data-sw="11">
                                    <i class="icona-check"></i>
                                    总评分
                                </span>
                            </li>
                            <li>
                                <span class="checkbox  checked" data-sw="10">
                                    <i class="icona-check"></i>
                                    分大题
                                </span>
                            </li>
                            <li>
                                <span class="checkbox  checked" data-sw="12">
                                    <i class="icona-check"></i>
                                    大题注释
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
                <h3>试题统计</h3>
                <div class="editset-type">
                    <div id="J_PaperTypes" class="overflow">
                        <div class="paper-club">
                            <div class="club-summary f-cb">
                                <div class="t1">分数：<strong>0分</strong></div>
                                <div class="w"><span class="t2">题数：<strong></strong></span></div>
                                <div class="t3">难度：<strong>困难</strong></div>
                            </div>
                            <div class="club-type-wrap">
                                #foreach($id in $ids)
                                <div class="club-type-wire drag-wire" _cid="type_1" data-typename="$id">
                                    <div class="club-type">
                                        <div class="club-hd f-cb">
                                            <span class="f-fl" title="$id">$T.GetNum($velocityCount)、$id</span>
                                        </div>
                                        <div class="club-grids">
                                            <div class="f-cb">
                                                #set($ques=$T.GetQues($id))
                                                #foreach($q in $ques)
                                                <span class="drag-grid" data-qid="$q.id">$velocityCount</span>
                                                #end
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                #end
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="g-mn1">
            <div class="g-mn1c">
                <table>
                    <tbody>
                        <tr>
                            <td data-paperset="1" class="editcon-silder" style="display: none;"></td>
                            <td>
                                <div class="editcon">
                                    <div class="test-title">
                                        <h1 data-paperset="3"><span class="contenteditable" data-edit="主标题" id="paper-title">${date}${sbname.Replace(" ","")}试卷</span></h1>
                                        <h2 data-paperset="5" style="display:none;"><span data-edit="副标题" class="contenteditable">${sbname.Replace(" ","")}考试</span></h2>
                                    </div>
                                    <div data-paperset="7" class="test-time" style="display:none;">
                                        <p><span>考试时间：<i class="contenteditable" data-edit="考试时间">60</i> 分钟</span><span>满分：<i class="contenteditable" data-edit="满分值">100</i> 分</span></p>
                                    </div>
                                    <ul data-paperset="9" class="stu-info" style="display:none;">
                                        <li>姓名：<span>____________</span></li>
                                        <li>班级：<span>____________</span></li>
                                        <li>学号：<span>____________</span></li>
                                    </ul>
                                    <div data-paperset="11" class="mark-table" style="display:none;">
                                        <table id="J_PaperScore">
                                            <tbody>
                                                <tr>
                                                    <th width="160">题号</th>
                                                    #foreach($id in $ids)
                                                    <td>$T.GetNum($velocityCount)</td>
                                                    #end
                                                </tr>
                                                <tr>
                                                    <th>评分</th>
                                                    #foreach($id in $ids)
                                                    <td>&nbsp;</td>
                                                    #end
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div data-paperset="4" class="rule" style="display:none;">
                                        <p>* 注意事项：</p>
                                        <div class="contenteditable" data-edit="注意事项">1、填写答题卡的内容用2B铅笔填写<br />2、提前 xx 分钟收取答题卡</div>
                                    </div>
                                    <div id="J_PaperBody">
                                        #set($no=0)
                                        #foreach($id in $ids)
                                        <div class="paper-part">
                                            <div class="paper-section" _cid="type_1">
                                                #set($ques=$T.GetQues($id))
                                                <div data-paperset="10" class="paper-types">
                                                    <!--<table data-paperset="2">
                                                        <tbody>
                                                            <tr><th>阅卷人</th><td></td></tr>
                                                            <tr><th>得&nbsp;&nbsp;分</th><td></td></tr>
                                                        </tbody>
                                                    </table>-->
                                                    <p><strong><b class="t-order">$T.GetNum($velocityCount)</b>、<span class="contenteditable" data-edit="大题名称">$id</span><span data-paperset="12">（共<b class="t-num">$ques.Count()</b>题；共<b class="t-score">0</b>分）</span></strong></p>
                                                    <div class="types-btngroup">
                                                        <a class="score-btn J_MultiSetScore" href="javascript:;" onclick="setBagScore(this)"><i class="icona-jiexi1"></i>批量设置得分</a>
                                                        <a class="del-btn J_DelQByType" href="javascript:;"><i class="icona-del3"></i>删除</a>
                                                    </div>
                                                </div>
                                                <div class="paper-question-list f-usn" onselectstart="return false">
                                                    #foreach($q in $ques)
                                                    #set($no=$no+1)
                                                    <div class="paper-question f-usn" onselectstart="return false" data-qid="${q.id}" data-easy="$q.easy">
                                                        <div class="question-txt">
                                                            <div class="question-num"><span class="q-sn">$no</span>. <span class="q-scoreval" data-score="$!q.score">（$!q.score分）</span>$q.topic</div>
                                                        </div>
                                                        <div class="question-btngroup">
                                                            <a target="_blank" href="javascript:;" onclick="show_jiexi($q.id)" class="jx-btn"><i class="icona-jiexi1"></i>答案解析</a>
                                                            <a class="score-btn" href="javascript:;" onclick="setScore(this)"><i class="icona-jiexi1"></i>设定得分</a>
                                                            #if($!q.fid==0)<a href="javascript:;" onclick="OT2_QCollect($q.id, this)"><i class="icona-shoucang"></i>收藏</a>#else<a href="javascript:;" onclick="OT2_QCollect($q.id, this)"><i class="icona-quxiaosc"></i>取消收藏</a>#end
                                                            <!--<a class="sc-btn" href="javascript:;" onclick="OT2_QCollect($q.id,this)"><i class="icona-shoucangs"></i>收藏</a>-->
                                                            <a class="del-btn" href="javascript:;" onclick="do_Del($q.id)"><i class="icona-del3"></i>删除</a>
                                                        </div>
                                                    </div>
                                                    #end
                                                </div>
                                            </div>
                                        </div>
                                        #end
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="editfooter">
        <!--<a href="javascript:;" onclick="paper.showPie()"><i class="icona-fenxi2"></i>试卷分析</a>-->
        <a href="javascript:;" onclick="do_save()"><i class="icona-save2"></i>保存组卷</a>
        <a href="javascript:;" class="download-btn" onclick="do_save(1)"><i class="icona-download1"></i>下载试卷</a>
    </div>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <script src="/js/xx/global.min.js"></script>
    <script src="/js/x.js"></script>
    <script type="text/javascript">
        var id = 0;
        $(function () {
            $("[data-edit]").click(function () {
                var ob = $(this);
                var name = ob.attr("data-edit");
                var text = ob.html().replace(/<br>/g, "\n");
                x.input(name, function (t) {
                    ob.html(t.trim().replace(/\n/g, "<br/>"));
                }, 2, true, text);
            });
            $("#J_PaperSetCheck li .checkbox").click(function () {
                var sw = $(this);
                sw.toggleClass("checked");
                $("[data-paperset='" + sw.attr("data-sw") + "']")[sw.hasClass("checked") ? "show" : "hide"]();
            });
            $(".club-grids [data-qid]").click(function () {
                var qid = $(this).attr("data-qid");
                var of = $("#J_PaperBody [data-qid='" + qid + "']").offset();
                //滚动定位到试题
            });
            updateTj();
        });

        function setBagScore(o) {
            var ques = $(o).parent().parent().next().find("[data-qid]");
            var sum = $(o).parent().prev().find(".t-score");
            x.input("单个题目的分值", function (t) {
                sum.text(ques.size() * t);
                ques.find(".q-scoreval").attr("data-score", t).text("（" + t + "分）");
                updateTj();
            }, 1, true, 2);
        }

        function setScore(o) {
            var q = $(o).parent().prev().find(".q-scoreval");
            x.input("这个题目的分值", function (t) {
                q.attr("data-score", t).text("（" + t + "分）");
                updateTj();
            }, 1, true, q.attr("data-score"));
        }

        function updateTj() {
            var ques = $(".paper-question")
            var ct = ques.size();

            var score = 0;
            var easy = { 1: 0, 2: 0, 3: 0 };
            ques.each(function () { score += parseInt($(this).find("[data-score]").attr("data-score")); easy[$(this).attr("data-easy")]++; });

            var esy = Math.max(easy[1], easy[2], easy[3]);
            $(".club-summary .t3 strong").text(esy == easy[1] ? "容易" : esy == easy[2] ? "普通" : "困难");
            $(".club-summary .t2 strong").text(ct);
            $(".club-summary .t1 strong").text(score);

            $(".paper-part").each(function () {
                var sum = 0;
                $(this).find(".q-scoreval").each(function () { sum += parseInt($(this).attr("data-score")) });
                $(this).find(".t-score").text(sum);
            });

        }

        function do_save(down) {
            var setting = {
                cfg: {},
                topic: $("[data-edit='主标题']").text(),
                stopic: $("[data-edit='副标题']").text(),
                time: $("[data-edit='考试时间']").text(),
                score: $("[data-edit='满分值']").text(),
                notice: $("[data-edit='注意事项']").html()
            };

            if (setting.cfg[3] && !setting.topic) { x.alert("主标题不能为空"); return; }
            if (setting.cfg[5] && !setting.stopic) { x.alert("副标题不能为空"); return; }
            if (setting.cfg[7] && (!setting.time || !setting.score)) { x.alert("考试时间和满分值不能为空"); return; }
            if (setting.cfg[4] && !setting.notice) { x.alert("注意事项不能为空"); return; }

            $("[data-sw]").each(function () {
                setting.cfg[$(this).attr("data-sw")] = $(this).hasClass("checked");
            });

            var qids = {};
            $("#J_PaperBody [data-qid]").each(function () {
                var q = $(this);
                qids[q.attr("data-qid")] = parseInt(q.find("[data-score]").attr("data-score"));
            });

            x.doapi("paper.save", {
                pid: id,
                sub: "$!sb",
                qids: JSON.stringify(qids),
                setting: JSON.stringify(setting)
            }, function (d) {
                if (d.issucc) {
                    id = d.msg;
                    x.cookie.del("xx.cart.$!sb");
                    if (down) do_down();
                    else x.alert("当前试卷已经保存，可以组卷记录里查看！")
                } else if (d.code == "0x0005") {
                    window.location.href = "/login--" + x.base64.encode(document.location.href) + ".html";
                }
            });
        }

        function do_down() {
            x.doapi("paper.predown", { pid: id }, function (d) {
                if (!d.issucc) return;
                if (!d.msg) do_pay();
                else $("#fr_down").attr("src", "/paper/down-" + d.msg + ".html");
            });
        }

        function do_pay() {
            x.openwin("/user/pay-1-" + id + ".html", "在线支付", function (d) {
                if (d == "succ") do_down();
            }, { w: 300, h: 400 });
        }

        function show_jiexi(id) {
            x.openwin("/answer-" + id + ".html", "查看解析", null, { w: 600, h: 400 });
        }

        function OT2_QCollect(id, bt) {
            var i = $(bt).find("i");
            if (i.hasClass("icona-shoucang")) {
                x.doapi("user.fav.save", { cid: id, tp: 1, sub: "$!sb" }, function (d) {
                    if (!d.issucc) return;
                    i.parent().html('<i class="icona-quxiaosc"></i>取消收藏')
                });
            } else {
                x.doapi("user.fav.del", { cid: id, tp: 1 }, function (d) {
                    if (!d.issucc) return;
                    i.parent().html('<i class="icona-shoucang"></i>收藏');
                });
            }
        }
    </script>
    <iframe id="fr_down" style="display:none;"></iframe>
    <a class="return" href="javascript:;" style="right: 4.5px; display: none;"><i class="icona-top"></i></a>
</body>
</html>
