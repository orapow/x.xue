OT2.Paper=function(){var e={1:"密封线",2:"大题评分区",3:"主标题",
4:"注意事项",5:"副标题",6:"分卷",7:"考试时间",8:"分卷注释",
9:"考生填写",10:"分大题",11:"总评分",12:"大题注释"},
t={simple:{name:"简易模板",
val:"3 10 12".split(/\s+/)},
common:{name:"普通模板",
val:"3 4 5 7 9 10 11 12".split(/\s+/)},
normal:{name:"正式模板",val:"1 2 3 4 5 6 7 8 9 10 11 12".split(/\s+/)}},i={"单选题":{name:"单选题",order:1,part:1},

      "多选题":{name:"多选题",order:2,part:1},
      "判断题":{name:"判断题",order:3,part:1}},
      n=function(e,i){OT2.Event.call(this),
      i="undefined"==typeof i?{}:i,
      this.$el=$("#J_PaperLayout"),
      this.$body=$(""),
	  this.editableInput=null,
	  this.attributes={template:"simple",
	  setting:_.clone(t.simple.val),title:"",
	  subtitle:"",xd:"",xk:"",xdName:"",
	  xkName:"",
	  notes:"1、填写答题卡的内容用2B铅笔填写<br>2、提前 xx 分钟收取答题卡",
	  paperPart:{1:{name:"第Ⅰ卷 客观题",tip:"第Ⅰ卷的注释"},
	  2:{name:"第Ⅱ卷 主观题",tip:"第Ⅱ卷的注释"}},
	  types:i,examtime:"* *",
	  score:"* *",
	  sheet:"1",
	  expires:(new Date).getTime()},
	  _.extend(this.attributes,e),
	  this.paper_key=["paper2016",
	  this.attributes.xd,this.attributes.xk].join(":"),
	  this.pid=null,this.cacheObj={},
	  this.basketQids=[]};
	  return n.prototype={init:function(e,t){var i=this;return"undefined"!=typeof t&&t&&(_.each(e,function(e){i.cacheObj[e.id]={id:e.id,order:1,type:e.type,xd:e.xd,xk:e.xk}}),
	  OT2.LocalData.set("basket_cacheObj",
	  JSON3.stringify(i.cacheObj))),this.unserialize(),
	  "undefined"!=typeof e?(i.render(e),i):void this.fetchQuestionsDetail("/getQuestionsByCategory").done(function(e){i.render(e)})},render:function(e){this.renderBody(e),this.bindEvent(),
	  this.renderPagerHeader(),
	  this.renderSideSet(),
	  this.renderSideTypes(),
	  this.initNewSideTypeDrag(),
	  this.initNewSideGridDrag(),
	  this.intervalPublish("question:width",150),
	  this.manual_events()},
	  renderSideTypes_old:function(){var e=OT2.Util.Template().get("paper-types"),
	  t=this.getList().length,
	  i=[],n=this.getParts();
	  n.sort(function(e,t){return e.id-t.id});
	  for(var s,a=0;s=n[a++];){var r=s.getSections();
	  r.sort(function(e,t){return e.order-t.order});for(var o,d=0;o=r[d++];){var l=o.getQuestions().length;
	  i.push({type:o.type,size:l})}}var c=$(_.template(e,{self:this,size:t,data:i}));
	  this.$sideTypes=$("#J_PaperTypes"),
	  this.$sideTypes.empty().append(c);
	  var e=OT2.Util.Template().get("paper-score"),u=$(_.template(e,{self:this}));$("#J_PaperScore").empty().append(u)},manual_events:function(){var e=this;this.$el.on("click",".toggle-sd-box",function(){var t=$(this).parent("h3").next("div"),i=!t.is(":visible");t[i?"show":"hide"](),this.innerHTML=i?"收起":"展开",e.autoHeightSideType()}),this.$sideTypes.on("click",".drag-grid",function(t){var i=$(this).attr("_qid");e.publish("question:scrolltoview",i)})},renderSideTypes:function(){var e=[],t=0,i=0,n=0,s={"容易":[0,1.7],"普通":[1.7,2.4],"困难":[2.4,1/0]},a=this.getParts().sort(function(e,t){return e.id-t.id});_.each(a,function(s,a){var r=s.getSections().sort(function(e,t){return e.order-t.order});_.each(r,function(s,a){var r=s.getQuestions().sort(function(e,t){return e.attributes.order-t.attributes.order}),o=s.type.substr(0,8);o=o.length>7?o+"...":o,e.push({type:s.type,short_type:o,_cid:s._cid,list:r}),_.each(r,function(e,s){i++,t+=e.attributes.score;var a=Number(e.model._difficult_index)||Number(e.model.difficult_index);n+=a||0})})}),i&&(n/=i,_.each(s,function(e,t){if(n>e[0]&&n<=e[1])return n=t,!1}));var r=OT2.Util.Template().get("paper-club"),o=$(_.template(r,{data:e,score:t,num:i,dd:n}));this.$sideTypes=$("#J_PaperTypes"),1
	  this.$sideTypes.html(o);
	  var r=OT2.Util.Template().get("paper-score"),
	  d=$(_.template(r,{self:this}));
	  $("#J_PaperScore").empty().append(d)},
	  getParts:function(){var e=[];return this.publish("part:sum",e),e},
	  getList:function(){var e=[];
	  return this.publish("question:list",this,e),e},
	  initSideTypeDragSorting:function(){return!1},
	  resortSections:function(){
	  var e=this;
	   e.$el.find("")
	  .each(function(t){
	   var i=$(this)
	  .attr("_cid");
	  e.publish("section:manual:resorting",i,t)})},
	  initNewSideTypeDrag:function(){var e=this;
	  $doc=$(document);
	  var t=!1,i=!1,
	  n=null,
	  s=null,
	  a=null,
	  r=null,
	  o=100,
	  d=!1,
	  l=0,
	  c=0,
	  u=0,
	  p=0,
	  h=0,
	  f=0,
	  v=0,
	  b="clone-drag-wire",
	  g="drag-wire-dragging",
	  y="sorting-section",
	  m=function(e){if(i){t=!0,
	  n.addClass(g);
	  var o=e.clientX-l,
	  p=e.clientY-c;s.offset({left:u,top:p}),
	  r=null,a.each(function(){var e=$(this),
	  t=this._offset,i=t.top,
	  s=t.left,a=e.height(),l=e.width(),
	  c=o>s+l||p>i+a||o+f<s||p+v<i;if(!c){r=this,d=p>h,
	  h=p;var u=d?"insertAfter":"insertBefore";return n[u](r),!1}})}};this.$sideTypes.on("mousedown","div.drag-wire",function(e){$("html,body").stop(),i=!0;var t=$(e.target);if((t.hasClass("t-del")||t.hasClass("t-order")||t.hasClass("drag-grid"))&&(i=!1),n=$(this),a=n.siblings(),0==a.length&&(i=!1),!i)return!1;a.each(function(){this._offset=$(this).offset()}),f=n.width(),v=n.height(),s=n.clone(),s.attr("id",b),s.css({position:"absolute",width:f,height:v,"z-index":o++});var r=n.offset();u=r.left,p=r.top,c=e.clientY-p,l=e.clientX-u,h=p,s.offset({left:u,top:p}),$("#"+b).length<1&&n.parent().append(s)}),$doc.on("mousemove",_.throttle(m,50)),$doc.on("mouseup",function(o){if(i&&t&&r){var l=d?"insertAfter":"insertBefore",c=n.data("typename"),u=$(r).data("typename"),p=e.getSectionByType(c),h=e.getSectionByType(u);p.part=h.part,e.attributes.types[c].part=h.part.id,p.$el[l](h.$el),p.$el.addClass(y),p.scrolltoView(),e.resortSections(),e.initQuestionListSort(),e.renderSideTypes(),e.serialize()}i&&(n&&n.removeClass(g),s&&s.remove(),s=null,t=!1,i=!1,n=null,a=null,r=null)})},initNewSideGridDrag:function(){var e=this,t=$(document),i=!1,n=!1,s=null,a=null,r=null,o=null,d=0,l=0,c=0,u=0,p=!1,h=0,f=500,v="grid-dragging",b=0,g=0,y=function(e){if(n){i=!0,o.addClass(v);var t=e.clientX-d,c=e.clientY-l;s.offset({left:t,top:c}),r=null,a.each(function(){var e=$(this),i=this._offset,n=i.left,s=i.top,a=e.width(),d=e.height(),l=t>n+a||c>s+d||t+b<n||c+g<s;if(!l)return p=t<h,h=t,r=this,o[p?"insertBefore":"insertAfter"](r),!1})}};this.$sideTypes.on("mousedown",".drag-grid",function(e){if($("html,body").stop(),e.stopPropagation(),n=!0,o=$(this),a=o.siblings(),0==a.length&&(n=!1),!n)return!1;a.each(function(){this._offset=$(this).offset()}),b=o.width(),g=o.height(),s=o.clone(),s.attr("id","clone-drag-grid"),s.css({position:"absolute",width:b,height:g,"z-index":f++});var t=o.offset();c=t.left,u=t.top,d=e.clientX-c,l=e.clientY-u,h=c,s.offset({left:c,top:u}),$("#clone-drag-grid").length<1&&o.parent().append(s)}),t.on("mousemove",_.throttle(y,50)),t.on("mouseup",function(t){if(n&&i){var d=o.parent().find(".drag-grid");d.each(function(t){if("clone-drag-grid"==this.id)return!0;var i=$(this).attr("_qid");e.publish("question:setorder","question-"+i,t)}),e.publish("paper:questionlist:sort"),e.renderSideTypes(),e.publish("question:scrolltoview",o.attr("_qid")),e.serialize()}n&&(o&&o.removeClass(v),a&&a.removeClass("grid-crash"),s&&s.remove(),i=!1,n=!1,s=null,o=null,a=null,r=null)})},resortSideGrids:function(){},getSectionByType:function(e){var t=null,i=this.getParts();return _.each(i,function(i){var n=i.getSections();_.each(n,function(i){if(e==i.type)return t=i,!1})}),t},getSectionByCid:function(e){var t=null;return _.each(this.getParts,function(i){_.each(i.getSections,function(i){if(e===i._cid)return t=i,!1})}),t},getPartById:function(e){var t=this.getParts();return _.find(t,function(t){return t.id==e})},getAllSection:function(){var e=[],t=this.getParts();return _.each(t,function(t){e=e.concat(t.getSections())}),e},renderBody:function(e){var t=this,n={};_.each(e,function(e){if(e&&e.id&&_.contains(t.basketQids,e.id)){var i=t.cacheObj[e.id]||{},s=i.type||e.type;n[e.id]={model:e,attr:i,type:s}}});var s=_.uniq(_.map(n,function(e){return e.type})),a={};_.each(s,function(e,t){var n=2;i[e]?a[e]=$.extend({},i[e]):a[e]={name:e,order:s.length,part:n}}),t.attributes.types=$.extend({},a,t.attributes.types),t.serialize();t.$body.empty();var r=0;_.map(t.attributes.paperPart,function(e,i){var n={id:i,name:e.name,tip:e.tip,order:r++};new OT2.Paper.Part(t,n).init()});var o=t.getParts();o.sort(function(e,t){return e.order-t.order});var d=0,l=_.sortBy(t.attributes.types,"order");_.each(o,function(e){_.each(l,function(i,s){var a=i.name;if(e.id==i.part){var r={order:d,type:a};t.attributes.types[a].order=d;var o=new OT2.Paper.Section(t,e,r);o.init(),_.chain(n).sortBy(function(e){return e.attr.sort}).each(function(e,i){if(e.type==a){var n=new OT2.Paper.Question(t,o,e.model,e.attr);o.$body.append(n.$el)}}),e.$el.append(o.$el),d++}}),t.$body.append(e.$el)}),t.initQuestionListSort(),t.serialize()},initQuestionListSort:function(){var e=this;e.subscribe("paper:questionlist:sort",function(){var t=e.getAllSection();t=_.sortBy(t,"order");var i=0;_.each(t,function(e){e.initQuestionSort(i),i+=e.getQuestions().length})}),e.publish("paper:questionlist:sort")},renderPagerHeader:function(){var e=this;this.$el.find(".contenteditable").each(function(){var t=$(this).data("edit");_.contains(["title","subtitle","examtime","score","notes"],t)&&$(this).html(e.attributes[t])})},fetchQuestionsDetail:function(e){var t=this,i=$.Deferred();return $.post(e,{list:t.basketQids},"json").done(function(e){i.resolve(e)}),i.promise()},serialize:function(){this.pid&&(this.pid=null),OT2.LocalData.set(this.paper_key,JSON3.stringify(this.attributes)),OT2.LocalData.set("basket_cacheObj",JSON3.stringify(this.cacheObj))},unserialize:function(){var e=null;try{e=JSON3.parse(OT2.LocalData.get(this.paper_key))}catch(t){}var i=(new Date).getTime();e&&(i-=e.expires,0==e.expires?this.attributes=e||this.attributes:i<6048e5&&(e.expires=(new Date).getTime(),this.attributes=e||this.attributes));var n={};try{n=JSON3.parse(OT2.LocalData.get("basket_cacheObj"))}catch(t){}this.cacheObj=n||{},this.getPaperBasketQids()},stringify:function(){var e=this,t={content:[],title:e.attributes.title,subtitle:e.attributes.subtitle,xd:e.attributes.xd,chid:e.attributes.xk,notes:e.attributes.notes,examtime:"考试时间：112&nbsp;分钟&nbsp;&nbsp;&nbsp;&nbsp;满分：33&nbsp;分",paperPart:e.attributes.paperPart,setting:e.attributes.setting},i={};try{i=JSON3.parse(OT2.LocalData.get("basket_cacheObj"))||{}}catch(n){}var i=_.sortBy(i,"order"),s=_.sortBy(e.attributes.types,"order");return _.each(s,function(n,s){var a={head_title:n.name,questions:[],scores:{}};_.each(i,function(t,i){if(t.type==n.name&&t.xd==e.attributes.xd&&t.xk==e.attributes.xk){a.questions.push(t.id);var s={score:"4"};"undefined"!=typeof t.subScore&&(s.subScore=t.subScore),"undefined"!=typeof t.score&&(s.score=t.score),a.scores[t.id]=s}}),t.content.push(a)}),t},getPaperBasketQids:function(){var e=this;return e.basketQids=[],_.each(e.cacheObj,function(t,i){e.basketQids.push(t.id)}),e.basketQids},getSetting:function(){return e},getPaperSet:function(){return t},renderSideSet:function(){var e=this,t=OT2.Util.Template().get("paper-template"),i={setting:this.getSetting(),paperset:this.getPaperSet(),attr:this.attributes};this.$set=$(_.template(t,i)),$("#J_PaperSetRadio").empty().append(this.$set),t=OT2.Util.Template().get("paper-setoptions"),this.$setopt=$(_.template(t,i)),$("#J_PaperSetCheck").empty().append(this.$setopt);var n=[],s=[];this.$set.find(".radiobox").each(function(){new OT2.Element.radio(this,n).bindEvent(function(){e.attributes.template=this.$input.val(),e.publish("paper:template",this.$input.val())})}),this.$setopt.find(".checkbox").each(function(){var t=new OT2.Element.checkbox(this,s);t.bindEvent(function(){e.publish("paper:setting",this.checked,this.$input.val()),1==this.$input.val()&&e.publish("question:width")}),e.publish("paper:setting",t.checked,t.$input.val()),e.subscribe("paper:template",function(i){var n=e.getPaperSet()[i].val,s=t.$input.val(),a=!1;_.contains(n,s)&&(a=!0),t.switchChecked(a,function(){e.publish("paper:setting",this.checked,this.$input.val())})})})},bindEvent:function(){var e=this;this.bindContentEditArea(),this.bindPaperSetting(),this.subscribe("question:destroy",function(t){e.destroyQuestionById(t.model.id,t),e.publish("paper:questionlist:sort"),e.renderSideTypes()}),this.subscribe("question:destroyBatch",function(t){e.destroyQuestionById(t.model.id,t),e.renderSideTypes()}),this.subscribe("question:replace",function(t,i){e.replaceQuestion(t,i)}),this.subscribe("question:transfer:renderSideType",function(t,i){e.cacheObj[t].type=i,e.serialize(),e.renderSideTypes()}),$(document).on("keyup",function(t){13==t.keyCode&&e.editableInput&&e.editableInput.is("input")&&e.editableInput.blur()}),$(window).on("scroll",_.throttle(function(){e.fixedSide()},100)),$(window).on("resize",_.debounce(function(){e.autoHeightSideType()},100))},replaceQuestion:function(e,t){var i=this;i.cacheObj[t.attributes.id]=$.extend(!0,{},t.attributes),delete i.cacheObj[e.attributes.id],e.paper=null,e.section=null,e=null,i.publish("question:width"),i.serialize()},deleteQuestions:function(e){var t=this,i=dialog({title:"友情提示",content:'你确定要删除"'+e+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){t.doDeleteQuestions(e)},cancel:function(){this.close()}});i.showModal()},doDeleteQuestions:function(e){this.publish("question:deleteBatch",e),delete this.attributes.types[e],this.publish("paper:questionlist:sort"),this.serialize(),this.renderSideTypes()},renderSideOrder:function(e){var t=[],i=this.getParts().sort(function(e,t){return e.id-t.id});_.each(i,function(e,i){var n=e.getSections().sort(function(e,t){return e.order-t.order});_.each(n,function(e,i){var n=e.type.substr(0,8);n=n.length>7?n+"...":n,t.push({_cid:e._cid,type:e.type,short_type:n})})});var n=$(_.template(OT2.Util.Template().get("club-sort"),{data:t,_cid:e})),s=[],a=[];return n.find(".custom-checkbox").each(function(){new OT2.Element.checkbox(this,s).bindEvent()}),n.find(".custom-radio").each(function(){new OT2.Element.radio(this,a).bindEvent()}),n},askOrder:function(e){var t=this,i=this.renderSideOrder(e),n=dialog({title:"试题排序",content:i,okValue:"确定",cancelValue:"取消",width:600,ok:function(){var e=i.find("form").serializeArray(),n=[],s=1;_.each(e,function(e,t){"type[]"===e.name&&n.push(e.value),"orderby"===e.name&&(s=e.value)}),t.multi_resort_questions(n,s)},cancel:function(){this.remove()}});n.showModal()},multi_resort_questions:function(e,t){var i=this,n=_.sortBy(i.getAllSection(),"order"),s=0,a=function(e,i){var n=Number(e.model._difficult_index-i.model._difficult_index)||0;return n*=t,0==n&&(n=Number(i.model.question_id-e.model.question_id)||0),n};_.each(n,function(t){_.contains(e,t._cid)&&t.initQuestionSort(s,a),s+=t.getQuestions().length}),i.serialize(),i.renderSideTypes()},bindPaperSetting:function(){var e=this;this.subscribe("paper:setting",function(t,i){e.$el.find("[data-paperset]").each(function(){i==$(this).data("paperset")&&$(this)[t?"show":"hide"]()}),e.attributes.setting=_.uniq(e.attributes.setting),t?e.attributes.setting.push(i):e.attributes.setting=_.reject(e.attributes.setting,function(e){return e==i}),e.serialize()})},bindContentEditArea:function(){this.listenContenteditable();var e=this;this.$el.on("click",".contenteditable",function(){var t=this,i=$(this).data("edit");if("undefined"==typeof this._input){"notes"==i?this._input=$("<textarea>"):this._input=$("<input>"),this._input.insertAfter(this);var n=this.innerHTML;this._input.on("blur",function(){n=$(this).data("oldvalue")||n,$(t).show(),$(this).hide();var s=$.trim(this.value);return!!s&&("notes"==i&&(this.value=s.replace(/\n/g,"<BR>")),$(t).html(this.value),$(this).data("oldvalue",this.value),e.publish("paper:contenteditable",i,this.value,t,n),void(e.editableInput=null))})}e.editableInput=this._input,this._input.show(),this._input.focus();var s=this.innerHTML;"notes"==i&&(s=s.replace(/<br>|<BR>/g,"\n")),this._input.val(s),$(this).hide()})},listenContenteditable:function(){var e=this;this.subscribe("paper:contenteditable",function(t,i,n,s){if(_.contains(["title","subtitle","examtime","score","notes"],t))e.attributes[t]=i;else if("paperPart.name"==t||"paperPart.tip"==t){var a=$(n).data("part"),r="tip";"paperPart.name"==t&&(r="name"),e.attributes.paperPart[a][r]=i}else"type"==t&&(e.publish("question:changeType",i,s),e.attributes.types[i]=$.extend({},e.attributes.types[s]),e.attributes.types[i].name=i,delete e.attributes.types[s],e.renderSideTypes());e.serialize()})},addNewType:function(){var e=this,t=$(_.template(OT2.Util.Template().get("add-type"),{})),i=t.find("input"),n=t.find(".error-msg"),s=dialog({title:"添加自定义题型",content:t.get(0),okValue:"确定",ok:function(){var t=$.trim(i.val()),a="";return t.length<=0?a="题型名称不能为空！":(t.length>10||t.length<3)&&(a="题型名称3-10个字符！"),n[a?"show":"hide"](),n.html(a),!a&&(e.insertNewType(t),void s.close())},fixed:!0,cancelValue:"取消",cancel:function(){}});s.showModal()},insertNewType:function(e){var t=this;if(t.attributes.types[e])return!1;var i=_.size(t.attributes.types);t.attributes.types[e]={name:e,order:i,part:2},t.serialize();var n=t.getPartById(2),s={type:e,order:i},a=new OT2.Paper.Section(t,n,s);a.init(),n.$el.append(a.$el),t.renderSideTypes(),a.scrolltoView()},destroyQuestionById:function(e,t){var i=this;delete i.cacheObj[e],"undefined"!=typeof t&&(t.paper=null,t.section=null,t=null),i.serialize()},save:function(){var e=this;e.saveProcess(function(){var t=(e.pid,OT2.Util.Template().get("dialog-save")),i=$(_.template(t,{pid:e.pid}));i.find("a").click(function(){return window.location.replace(this.href),!1});var n=dialog({title:"提示",content:i.get(0),fixed:!0});n.showModal(),i.find("#b-download").click(function(){e.download(),n.close()}),i.find("#b-share").click(function(){e.shareDialog(),n.close()})})},saveProcess:function(e){var t=this;if(t.pid)return e(),!1;var i=this.stringify();i.pid=t.pid,$.post("/paper/create",i,function(i){if(0==i.errCode){t.pid=i.data.pid,OT2.LocalData.remove(t.paper_key);var n={};try{n=JSON3.parse(OT2.LocalData.get("basket_cacheObj")),_.each(n,function(e,i){e.xd==t.attributes.xd&&e.xk==t.attributes.xk&&delete n[i]})}catch(s){}OT2.LocalData.set("basket_cacheObj",JSON3.stringify(n)),e()}else OT2.Util.alert("试题保存失败,请检查试卷排版")},"json")},adminSave:function(e,t){var i=this;i.pid=e;var n=this.stringify();$.post("/paper/admin-create?pid="+i.pid+"&type="+t,n,function(e){0==e.errCode?(i.pid=e.data.pid,OT2.LocalData.remove(i.paper_key),OT2.LocalData.remove("basket_cacheObj"),OT2.LocalData.remove("basket_cachePid"),OT2.Util.alert("试卷保存成功"),window.location.replace("/paper/view/"+i.pid)):OT2.Util.alert("试题保存失败,请检查试卷排版")},"json")},download:function(e){var t=this;return"undefined"!=typeof e&&(t.pid=e),"undefined"==typeof USER.uid?(OT2.Global.initLogin(),!1):void t.saveProcess(function(){var e;$.ajax({url:"/paper/download-params",data:{pid:t.pid},dataType:"json",async:!1,success:function(t){e=t.data}});var i={chooseType:"student",chooseSize:"A4"},n="下载",s=function(){OT2.Util.alert("生成试卷,请耐心等待"),window.location="/paper/download?pid="+t.pid+"&size="+i.chooseSize+"&type="+i.chooseType};e.isCan||(n="充值学币",DDDD=function(){window.location.replace("http://www.21cnjy.com/pay/")});var a=[],r=[],o=e.view,d=$(_.template(o,{}));d.find(".download-size .radiobox").each(function(){new OT2.Element.radio(this,a).bindEvent(function(){i.chooseSize=this.$input.val()})}),d.find(".download-type .radiobox").each(function(){new OT2.Element.radio(this,r).bindEvent(function(){i.chooseType=this.$input.val()})}),d.find("button.recharge-btn").on("click",function(){u.close(),s()});var l=function(){$.get("/payment/check-order",{pid:t.pid,username:USER.username},function(e){"success"==e&&(d.find(".down_btn .recharge-btn").first().trigger("click"),"undefined"!=typeof c&&clearInterval(c))})};if(!e.isCan)var c=setInterval(l,1e3);var u=dialog({title:"下载word试卷",content:d,width:450,onclose:function(){"undefined"!=typeof c&&(clearInterval(c),c=null)}});u.showModal()})},showPie:function(e){var t=this;if("undefined"!=typeof e&&(t.pid=e),t.pid)OT2.PaperAnalysis.show("/paper/pie/"+t.pid);else if(!t.pid){var i={},n=JSON3.parse(OT2.LocalData.get("basket_cacheObj")),s=this.stringify();_.each(n,function(e,t){i[e.id]=e.id}),$.post("/paper/pie",{qids:i,content:s.content},function(e){0==e.errCode&&OT2.PaperAnalysis.show1(e.data)})}},shareDialog:function(e){var t=this;"undefined"!=typeof e?t.pid=e:t.pid||OT2.Util.alert("请先保存试卷");var i={title:t.attributes.title},n="";if($.ajax({url:"/paper/share-info",data:{pid:t.pid},dataType:"json",async:!1,success:function(e){i=e.data,0!=e.errCode&&(n=e.message)}}),""!==n)return void OT2.Util.alert(n);i.pid=t.pid;var s=OT2.Util.Template().get("dialog-share"),a=$(_.template(s,i)),r=dialog({title:"试卷共享编辑",content:a.get(0),okValue:"确定",cancelValue:"取消",ok:function(){var e=a.find("#share-form").serializeArray();$.post("/paper/share",e,function(e){0==e.errCode?OT2.Util.alert("试卷分享成功"):OT2.Util.alert(e.message)},"json"),r.close()},cancel:function(){}});r.showModal()},collectPaper:function(e,t){var i=this;"undefined"!=typeof e?i.pid=e:i.pid||OT2.Util.alert("请先保存试卷"),$.get("/paper/collect",{pid:i.pid},function(e){0==e.errCode?(OT2.Util.alert(e.message),t("收藏成功"==e.message)):OT2.Util.alert(e.message)})},setAnswerSheet:function(e){var t=this;"undefined"!=typeof e&&(t.pid=e),!t.pid,t.saveProcess(function(){var e=t.attributes.sheet,i=OT2.Util.Template().get("dialog-answer-sheet"),n=$(_.template(i,{self:t}));n.vmenu=n.find(".menu"),n.vsheetlist=n.find(".sheet-list"),n.vtit=n.find(".s-title"),n.vsheets=n.find(".sheet div"),n.vmenu.on("click",function(){n.vsheetlist.show(),$(this).addClass("active")}),n.vsheetlist.find("li").on("click",function(t){t.stopPropagation(),n.vsheetlist.hide(),n.vtit.html(this.innerHTML),e=$(this).data("sheet"),n.vsheets.hide(),n.vsheets.eq(e-1).show(),n.vmenu.removeClass("active")}),$(document).on("click",function(e){0!=$(e.target).parents(".menu").length||$(e.target).hasClass("menu")||(n.vsheetlist.hide(),n.vmenu.removeClass("active"))}),n.vsheetlist.find('li[data-sheet="'+e+'"]').click();var s=dialog({title:"下载答题卡",content:n.get(0),okValue:"确定",cancelValue:"取消",ok:function(){var i={1:"c",2:"a",3:"b"};t.attributes.sheet=e,OT2.Util.alert("生成试卷答题卡中,请耐心等待"),window.location="/paper/download-answer-sheet?pid="+t.pid+"&size="+i[e],t.serialize()},cancel:function(){}});s.showModal()})},fixedSide:function(){var e=document.body.scrollTop||document.documentElement.scrollTop;this.isFixedSide=e>110,this.$el[this.isFixedSide?"addClass":"removeClass"]("fixed"),this.autoHeightSideType()},autoHeightSideType:function(){var e=document.documentElement.clientHeight;"undefined"==typeof this.sideTypes_Height&&(this.sideTypes_Height=this.$sideTypes.height());var t=$("#sd-set-wire"),i=t.height();t.is(":visible")||(i=0),e=this.isFixedSide?e-i-190:e-i-300,this.sideTypes_Height<e?(this.$sideTypes.css({height:"auto"}),this.$sideTypes.removeClass("overflow")):(this.$sideTypes.css({height:e}),this.$sideTypes.addClass("overflow"))}},_.extend(n.prototype,OT2.Event.prototype),n}();